<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base :: parent(~{::#content}, ~{::#leftContent}, ~{::#rightContent}, 'Summary', 'Duct Specifications')}">

<head>
    <style>
        .accordion-body {
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        .accordion-body.open {
            opacity: 1;
            max-height: 1500px;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .accordion-btn .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-btn.open .chevron {
            transform: rotate(90deg);
        }
    </style>
</head>

<body>

<section id="content" class="w-full flex flex-col items-center gap-8">

    <div class="text-center">
        <h2 class="text-3xl font-bold text-gray-800">Optimization Results</h2>
        <p class="text-gray-500 mt-1">Analysis of various duct configurations against fan count.</p>
    </div>

    <!-- Charts -->
    <!-- <div class="w-full max-w-7xl grid grid-cols-1 gap-8"> -->
        <div class="w-full max-w-7xl space-y-4 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 min-h-[400px] flex flex-col items-center">
            <canvas id="concentrationChart"></canvas>
        </div>
        <!-- <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"> -->
            <div class="w-full max-w-7xl space-y-4 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 min-h-[400px] flex flex-col items-center">
                <canvas id="airFlowFaceChart"></canvas>
            </div>
            <div class="w-full max-w-7xl space-y-4 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 min-h-[400px] flex flex-col items-center">
                <canvas id="airFlowEntryChart"></canvas>
            </div>
        <!-- </div> -->
    <!-- </div> -->

    <div class="w-full max-w-7xl space-y-4" id="resultTables"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Data Initialization ---
        const concentrationsData = /*[[${result.concentrations}]]*/ null;
        const airFlowRateAtEntryData = /*[[${result.airFlowRateAtEntry}]]*/ null;
        const airFlowRateAtFaceData = /*[[${result.airFlowRateAtFace}]]*/ null;
        const ductSpecsData = /*[[${result.ductSpecification}]]*/ null;
        const allResultsData = /*[[${result.allResults}]]*/ null;
        const maxConc = /*[[${result.maxConc}]]*/ null;

        const concentrations = concentrationsData || [];
        const airFlowRateAtEntry = airFlowRateAtEntryData || [];
        const airFlowRateAtFace = airFlowRateAtFaceData || [];
        const ductSpecs = ductSpecsData || [];
        const allResults = allResultsData || [];

        if (concentrations.length === 0) {
            const container = document.getElementById('content');
            if(container) container.innerHTML += '<p class="text-red-500 font-semibold">No optimization results to display.</p>';
            return;
        }

        const maxFans = Math.max(0, ...concentrations.map(list => list ? list.length : 0));
        const fanLabels = Array.from({ length: maxFans }, (_, i) => i + 1);
        const colors = concentrations.map((_, idx) => `hsl(${(idx * 60 + 10) % 360}, 75%, 55%)`);

        // --- 2. Render Functions ---
        function renderResultAccordions() {
            const container = document.getElementById('resultTables');
            if (!container) return;
            concentrations.forEach((concList, idx) => {
                let rowsHTML = '';
                (concList || []).forEach((conc, fanIdx) => {
                    const entry = airFlowRateAtEntry[idx]?.[fanIdx] ?? 'N/A';
                    const face = airFlowRateAtFace[idx]?.[fanIdx] ?? 'N/A';
                    const resultObj = allResults[idx]?.[fanIdx] ?? {};
                    const resultJsonString = JSON.stringify(resultObj).replace(/'/g, '&apos;');

                    rowsHTML += `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-2 border-b">${fanIdx + 1}</td>
                            <td class="px-4 py-2 border-b">${Number(conc).toFixed(3)}</td>
                            <td class="px-4 py-2 border-b">${typeof entry === 'number' ? Number(entry).toFixed(2) : entry}</td>
                            <td class="px-4 py-2 border-b">${typeof face === 'number' ? Number(face).toFixed(2) : face}</td>
                            <td class="px-4 py-2 border-b">
                                <form action="/show" method="post" target="_blank">
                                    <input type="hidden" name="resultJson" value='${resultJsonString}'/>
                                    <button type="submit" class="p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                    </button>
                                </form>
                            </td>
                        </tr>`;
                });

                const accordionHTML = `
                    <button class="accordion-btn w-full flex justify-between items-center text-left px-5 py-4 font-bold text-lg text-gray-800 bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex items-center gap-4">
                            <span style="background-color:${colors[idx]};" class="w-6 h-6 rounded-md flex-shrink-0"></span>
                            <span>Duct #${idx + 1} Results</span>
                        </div>
                        <svg class="chevron w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                    <div class="accordion-body">
                        <div class="overflow-x-auto p-4">
                            <table class="w-full text-sm text-center">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th class="px-4 py-2 font-semibold border-b-2">Fan No.</th>
                                        <th class="px-4 py-2 font-semibold border-b-2">Concentration (mg/m³)</th>
                                        <th class="px-4 py-2 font-semibold border-b-2">Flow at Entry (m³/s)</th>
                                        <th class="px-4 py-2 font-semibold border-b-2">Flow at Face (m³/s)</th>
                                        <th class="px-4 py-2 font-semibold border-b-2">Action</th>
                                    </tr>
                                </thead>
                                <tbody>${rowsHTML}</tbody>
                            </table>
                        </div>
                    </div>`;
                const accordionWrapper = document.createElement('div');
                accordionWrapper.id = `ductTable-${idx}`;
                accordionWrapper.className = "bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden";
                accordionWrapper.innerHTML = accordionHTML;
                container.appendChild(accordionWrapper);
            });
        }

        function initializeCharts() {
            const createGradient = (ctx, color) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, `${color}40`);
                gradient.addColorStop(1, `${color}00`);
                return gradient;
            };
            const createDatasets = (dataArray, labelPrefix) => {
                return (dataArray || []).map((list, idx) => ({
                    label: `${labelPrefix} #${idx + 1}`, data: list, borderColor: colors[idx],
                    backgroundColor: (context) => createGradient(context.chart.ctx, colors[idx]),
                    pointBackgroundColor: colors[idx], pointRadius: 4, pointHoverRadius: 7, fill: true, tension: 0.3
                }));
            };
            const legendClickHandler = (e, legendItem, chart) => {
                const idx = legendItem.datasetIndex;
                chart.toggleDataVisibility(idx);
                chart.update();
                const accordion = document.getElementById(`ductTable-${idx}`);
                if (accordion) {
                    accordion.querySelector('.accordion-body').classList.add('open');
                    accordion.querySelector('.accordion-btn').classList.add('open');
                    accordion.scrollIntoView({ behavior:'smooth', block:'center' });
                }
            };
            const baseChartOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', onClick: legendClickHandler } },
                scales: { 
                    x: { title: { display: true, text: 'Number of Fans', font: { size: 14 } }, grid: { display: false } }, 
                    y: { title: { display: true, font: { size: 14 } }, grid: { color: '#e5e7eb' } }
                }
            };
            new Chart(document.getElementById('concentrationChart'), {
                type: 'line', data: { labels: fanLabels, datasets: createDatasets(concentrations, 'Conc.') },
                options: { ...baseChartOptions, plugins: { ...baseChartOptions.plugins, title: { display: true, text: 'Dust Concentration vs. Number of Fans', font: { size: 18 } }, annotation: { annotations: { maxLine: { type: 'line', yMin: maxConc, yMax: maxConc, borderColor: 'rgb(239, 68, 68)', borderWidth: 2, borderDash: [6, 6], label: { content: 'Max Allowed', enabled: true, position: 'end', backgroundColor: 'rgba(239, 68, 68, 0.8)' } } } } }, scales: { ...baseChartOptions.scales, y: { ...baseChartOptions.scales.y, title: { ...baseChartOptions.scales.y.title, text: 'Concentration (mg/m³)' } } } }
            });
            new Chart(document.getElementById('airFlowEntryChart'), {
                type: 'line', data: { labels: fanLabels, datasets: createDatasets(airFlowRateAtEntry, 'Flow Entry') },
                options: { ...baseChartOptions, plugins: { ...baseChartOptions.plugins, title: { display: true, text: 'Air Flow at Entry', font: { size: 18 } } }, scales: { ...baseChartOptions.scales, y: { ...baseChartOptions.scales.y, title: { ...baseChartOptions.scales.y.title, text: 'Air Flow Rate (m³/s)' } } } }
            });
            new Chart(document.getElementById('airFlowFaceChart'), {
                type: 'line', data: { labels: fanLabels, datasets: createDatasets(airFlowRateAtFace, 'Flow Face') },
                options: { ...baseChartOptions, plugins: { ...baseChartOptions.plugins, title: { display: true, text: 'Air Flow at Face', font: { size: 18 } } }, scales: { ...baseChartOptions.scales, y: { ...baseChartOptions.scales.y, title: { ...baseChartOptions.scales.y.title, text: 'Air Flow Rate (m³/s)' } } } }
            });
        }
        
        // --- 3. Delegated Event Listener (fix) ---
        function setupEventListeners() {
            const container = document.getElementById('resultTables');
            if (!container) return;

            container.addEventListener('click', (e) => {
                const btn = e.target.closest('.accordion-btn');
                if (!btn) return;
                const body = btn.nextElementSibling;
                btn.classList.toggle('open');
                body.classList.toggle('open');
            });
        }

        // --- 4. Execute all functions in order ---
        renderResultAccordions();
        initializeCharts();
        setupEventListeners(); // now works with delegation
    });
    /*]]>*/
    </script>
</section>

<div id="leftContent">
    <div class="bg-white p-4 rounded-xl shadow-md border space-y-3">
        <h4 class="font-bold text-gray-700">Simulation Parameters</h4>
        <div class="text-sm space-y-2 text-gray-600">
            <p><strong>Emission Rate:</strong> <span th:text="${result.emissionRate} + ' mg/s'"></span></p>
            <p><strong>Fan Curve:</strong> <span th:text="'P = ' + ${result.a} +'Q² + ' + ${result.b}"></span></p>
        </div>
    </div>
</div>

<div id="rightContent" class="space-y-3">
    <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        const ductSpecsData = /*[[${result.ductSpecification}]]*/ null;
        const ductSpecs = ductSpecsData || [];
        const colors = ductSpecs.map((_, idx) => `hsl(${(idx * 60 + 10) % 360}, 75%, 55%)`);
        const container = document.getElementById('rightContent');

        if (container && ductSpecs.length > 0) {
            container.innerHTML = '';
            ductSpecs.forEach((spec, idx) => {
                const card = document.createElement('div');
                card.className = "duct-spec-card bg-white rounded-xl shadow-md border p-4 cursor-pointer hover:shadow-lg hover:border-blue-500 transition-all duration-300";
                card.addEventListener('click', () => {
                    const accordion = document.getElementById(`ductTable-${idx}`);
                    if (accordion) {
                        accordion.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        accordion.style.transition = 'all 0.3s';
                        accordion.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.5)';
                        setTimeout(() => { accordion.style.boxShadow = ''; }, 1500);
                    }
                });
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-bold text-gray-800">Duct #${idx + 1}</h4>
                        <span style="background-color:${colors[idx]};" class="w-5 h-5 rounded-md"></span>
                    </div>
                    <table class="w-full text-xs text-left">
                        <tbody>
                            <tr class="border-b border-gray-200"><td class="py-1 pr-2 font-medium text-gray-500">Diameter</td><td class="py-1 text-gray-800 font-semibold">${spec.ductDiameters} m</td></tr>
                            <tr class="border-b border-gray-200"><td class="py-1 pr-2 font-medium text-gray-500">Friction Factor</td><td class="py-1 text-gray-800 font-semibold">${spec.frictionFactor}</td></tr>
                            <tr class="border-b border-gray-200"><td class="py-1 pr-2 font-medium text-gray-500">Seg. Length</td><td class="py-1 text-gray-800 font-semibold">${spec.segmentLength} m</td></tr>
                            <tr class="border-b border-gray-200"><td class="py-1 pr-2 font-medium text-gray-500">Seg. Count</td><td class="py-1 text-gray-800 font-semibold">${spec.segmentCount}</td></tr>
                            <tr><td class="py-1 pr-2 font-medium text-gray-500">Leakage Res.</td><td class="py-1 text-gray-800 font-semibold">${spec.leakageResistance} /100m</td></tr>
                        </tbody>
                    </table>`;
                container.appendChild(card);
            });
        }
    });
    /*]]>*/
    </script>
</div>
</body>
</html>
